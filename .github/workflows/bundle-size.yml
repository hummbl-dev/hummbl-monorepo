name: Bundle Size Monitoring

on:
  pull_request:
    paths:
      - 'apps/web/**'
      - 'packages/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
  push:
    branches:
      - main
    paths:
      - 'apps/web/**'
      - 'packages/**'
      - 'package.json'
      - 'pnpm-lock.yaml'

jobs:
  bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4        
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: pnpm --filter @hummbl/web build

      - name: Generate bundle stats
        run: |
          cd apps/web
          # Create bundle analysis
          echo "ðŸ“Š Bundle Analysis Report" > bundle-report.md
          echo "=========================" >> bundle-report.md
          echo "" >> bundle-report.md

          # Get bundle sizes
          echo "## Bundle Sizes" >> bundle-report.md
          echo "" >> bundle-report.md

          # Check if dist directory exists
          if [ -d "dist" ]; then
            echo "| File | Size (Original) | Size (Gzipped) |" >> bundle-report.md
            echo "|------|----------------|----------------|" >> bundle-report.md

            for file in dist/assets/*.js dist/assets/*.css; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                original_size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "0")
                gzipped_size=$(gzip -c "$file" | wc -c)

                # Convert to KB
                original_kb=$((original_size / 1024))
                gzipped_kb=$((gzipped_size / 1024))

                echo "| $filename | ${original_kb}KB | ${gzipped_kb}KB |" >> bundle-report.md
              fi
            done

            echo "" >> bundle-report.md
            echo "## Size Budgets Check" >> bundle-report.md
            echo "" >> bundle-report.md

            # Check main bundle size (look for main/index files)
            main_js_size=0
            css_size=0
            max_chunk_size=0

            for file in dist/assets/*.js; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                gzipped_size=$(gzip -c "$file" | wc -c)
                gzipped_kb=$((gzipped_size / 1024))

                # Check if this is a main bundle (contains main or index in name)
                if [[ "$filename" == *"main"* ]] || [[ "$filename" == *"index"* ]]; then
                  main_js_size=$gzipped_kb
                fi

                # Track max chunk size
                if [ $gzipped_kb -gt $max_chunk_size ]; then
                  max_chunk_size=$gzipped_kb
                fi
              fi
            done

            for file in dist/assets/*.css; do
              if [ -f "$file" ]; then
                gzipped_size=$(gzip -c "$file" | wc -c)
                css_kb=$((gzipped_size / 1024))
                css_size=$((css_size + css_kb))
              fi
            done

            # Check budgets
            budget_passed=true

            # Main JS bundle: <200KB gzipped
            if [ $main_js_size -gt 200 ] && [ $main_js_size -gt 0 ]; then
              echo "âŒ **Main JS Bundle**: ${main_js_size}KB (exceeds 200KB budget)" >> bundle-report.md
              budget_passed=false
            else
              echo "âœ… **Main JS Bundle**: ${main_js_size}KB (within 200KB budget)" >> bundle-report.md
            fi

            # CSS bundle: <50KB gzipped
            if [ $css_size -gt 50 ] && [ $css_size -gt 0 ]; then
              echo "âŒ **CSS Bundle**: ${css_size}KB (exceeds 50KB budget)" >> bundle-report.md
              budget_passed=false
            else
              echo "âœ… **CSS Bundle**: ${css_size}KB (within 50KB budget)" >> bundle-report.md
            fi

            # Individual chunks: <100KB gzipped
            if [ $max_chunk_size -gt 100 ]; then
              echo "âŒ **Largest Chunk**: ${max_chunk_size}KB (exceeds 100KB budget)" >> bundle-report.md
              budget_passed=false
            else
              echo "âœ… **Largest Chunk**: ${max_chunk_size}KB (within 100KB budget)" >> bundle-report.md
            fi

            # Set environment variable for later steps
            if [ "$budget_passed" = "false" ]; then
              echo "BUDGET_CHECK=failed" >> $GITHUB_ENV
            else
              echo "BUDGET_CHECK=passed" >> $GITHUB_ENV
            fi
          else
            echo "âŒ Build failed: dist directory not found" >> bundle-report.md
            echo "BUDGET_CHECK=failed" >> $GITHUB_ENV
          fi

      - name: Compressed Size Action
        uses: preactjs/compressed-size-action@v2
        with:
          repo-token: '${{ secrets.GITHUB_TOKEN }}'
          pattern: 'apps/web/dist/**/*.{js,css,html}'
          exclude: '{**/*.map,**/node_modules/**}'
          minimum-change-threshold: 100
          omit-unchanged: 'diff-only'

      - name: Comment PR with Bundle Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read the bundle report
            let report = '';
            try {
              report = fs.readFileSync('apps/web/bundle-report.md', 'utf8');
            } catch (error) {
              report = 'âŒ Failed to generate bundle report';
            }

            // Create comment body
            const commentBody = `## ðŸ“¦ Bundle Size Report

            ${report}

            ---
            *Generated by Bundle Size Monitor*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('ðŸ“¦ Bundle Size Report')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
            }

      - name: Check Bundle Size Budgets
        if: env.BUDGET_CHECK == 'failed'
        run: |
          echo "âŒ Bundle size budget exceeded!"
          echo "Please review the bundle size report and consider:"
          echo "1. Code splitting to reduce chunk sizes"
          echo "2. Removing unused dependencies"
          echo "3. Lazy loading components"
          echo "4. Using dynamic imports for large libraries"
          exit 1

      - name: Upload Bundle Analysis
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-${{ github.event.pull_request.number }}
          path: |
            apps/web/dist/
            apps/web/bundle-report.md
          retention-days: 7

  bundle-analyzer:
    name: Bundle Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Add bundle analyzer
        run: |
          cd apps/web
          pnpm add -D webpack-bundle-analyzer rollup-plugin-visualizer

      - name: Generate bundle analysis
        run: |
          cd apps/web
          # Create Vite bundle analyzer script
          cat > analyze-bundle.js << 'EOF'
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';
          import { visualizer } from 'rollup-plugin-visualizer';
          import path from 'path';

          export default defineConfig({
            plugins: [
              react(),
              visualizer({
                filename: 'dist/bundle-analysis.html',
                open: false,
                gzipSize: true,
                brotliSize: true,
                template: 'treemap'
              })
            ],
            resolve: {
              alias: {
                '@': path.resolve(__dirname, './src'),
                '@hummbl/core': path.resolve(__dirname, '../../packages/core/src/index.ts'),
              },
            },
            build: {
              target: 'esnext',
              minify: 'esbuild',
              chunkSizeWarningLimit: 500,
              rollupOptions: {
                output: {
                  manualChunks: {
                    'vendor-react': ['react', 'react-dom', 'react-router-dom'],
                    'vendor-query': ['@tanstack/react-query'],
                    'vendor-ui': ['class-variance-authority', 'tailwind-merge', 'lucide-react'],
                    'vendor-graph': ['react-force-graph-2d'],
                    'vendor-http': ['axios'],
                  },
                  entryFileNames: 'assets/[name]-[hash].js',
                  chunkFileNames: 'assets/[name]-[hash].js',
                  assetFileNames: 'assets/[name]-[hash][extname]',
                },
              },
              sourcemap: false,
            },
            optimizeDeps: {
              include: ['react', 'react-dom', 'react-router-dom', '@tanstack/react-query'],
              exclude: ['react-force-graph-2d'],
            },
          });
          EOF

          # Build with analyzer
          npx vite build --config analyze-bundle.js

      - name: Upload Bundle Analysis Report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-visualization-${{ github.event.pull_request.number }}
          path: |
            apps/web/dist/bundle-analysis.html
          retention-days: 7

      - name: Comment Bundle Analysis Link
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## ðŸ“Š Bundle Analysis Visualization

            A detailed bundle analysis has been generated for this PR.

            ðŸ“ **Download the analysis**: Check the "bundle-analysis-visualization-${{ github.event.pull_request.number }}" artifact in the workflow run.

            The visualization shows:
            - Bundle composition and chunk sizes
            - Dependencies and their impact
            - Opportunities for optimization

            ---
            *Bundle analysis available in workflow artifacts*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: commentBody
            });
